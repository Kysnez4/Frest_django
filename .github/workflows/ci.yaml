name: Django CI/CD with Docker

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Start Docker Compose for tests
      run: |
        # Копируем .env.example если нет .env
        cp .env.example .env 2>/dev/null || echo "No .env.example found"
        
        # Запускаем тестовые сервисы
        docker-compose -f docker-compose.test.yml up -d db redis
        
        # Ждем готовности базы
        timeout 30s bash -c 'until docker-compose -f docker-compose.test.yml exec db pg_isready -U postgres; do sleep 2; done'

    - name: Build and test
      env:
        SECRET_KEY: ${{ secrets.SECRET_KEY }}
        DATABASE_URL: postgres://postgres:postgres@localhost:5432/test_db
      run: |
        # Собираем образ
        docker-compose -f docker-compose.test.yml build web
        
        # Запускаем тесты в контейнере
        docker-compose -f docker-compose.test.yml run --rm web \
          sh -c "python manage.py migrate && python manage.py test"

    - name: Stop Docker Compose
      if: always()
      run: |
        docker-compose -f docker-compose.test.yml down -v

  deploy:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    steps:
    - uses: actions/checkout@v4

    - name: Deploy with Docker Compose
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_IP }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          cd ${{ secrets.DEPLOY_DIR }}
          
          # Обновляем код
          git pull origin main
          
          # Копируем .env файл если нужно
          if [ ! -f .env ]; then
            echo "Creating .env file..."
            cat > .env << 'EOF'
          DEBUG=False
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          DB_NAME=${{ secrets.DB_NAME }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_HOST=db
          DB_PORT=5432
          REDIS_URL=redis://redis:6379/0
          CELERY_BROKER_URL=redis://redis:6379/0
          CELERY_RESULT_BACKEND=redis://redis:6379/0
          EOF
          fi
          
          # Останавливаем старые контейнеры
          docker-compose down || true
          
          # Собираем и запускаем
          docker-compose up -d --build
          
          # Ждем запуска и выполняем миграции
          sleep 10
          docker-compose exec -T web python manage.py migrate
          docker-compose exec -T web python manage.py collectstatic --noinput --clear
          
          echo "✅ Deployment completed successfully!"